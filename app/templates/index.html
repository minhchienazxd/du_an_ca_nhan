<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>KQ XSMB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    .so-container-6 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    /* CSS comment */
    .comments-container { margin-top: 5px; padding-left: 10px; }
    .comment { margin-bottom: 3px; font-size: 0.9em; }
    .post input[type=text] { width: 100%; padding: 4px; margin-top: 5px; }
    .actions button { cursor: pointer; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; background: #f0f0f0; transition: all 0.3s; }
    .actions button.liked { background-color: #007bff; color: white; border-color: #0056b3; }

    /* Highlight post khi t·ª´ th√¥ng b√°o */
    .highlight-post { background-color: #fffae6; transition: background 3s; }

    /* Notification */
    .notifications { display: none; margin-top: 10px; max-height: 400px; overflow-y: auto; }
    .notification { 
      cursor: pointer; 
      padding: 10px; 
      border-bottom: 1px solid #eee; 
      display: flex;
      align-items: center;
    }
    .notification:hover { background-color: #f0f0f0; }
    .notification.unseen { background-color: #e6f7ff; font-weight: bold; }
    .notification img { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      margin-right: 10px; 
    }
    .notification-content { flex: 1; }
    .notification-time { 
      font-size: 0.8em; 
      color: #888; 
      margin-top: 3px; 
    }
    .notification-actions { margin-top: 5px; }
    .notification-actions button { 
      padding: 3px 8px; 
      margin-right: 5px; 
      font-size: 0.8em; 
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
    }
    .accept-btn { background-color: #4CAF50; color: white; }
    .reject-btn { background-color: #f44336; color: white; }
    .toast-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 300px;
      cursor: pointer;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

  <!-- Menu mobile -->
  <div class="menu-wrapper">
    <button class="hamburger-btn">‚ò∞</button>
    <div id="menu-items" class="menu-hidden">
      {% if user %}
        <a href="/nap-tien"><i class="fas fa-wallet"></i> N·∫°p ti·ªÅn</a>
        <a href="/rut-tien"><i class="fas fa-money-bill-wave"></i> R√∫t ti·ªÅn</a>
        <a href="/ghi-lo"><i class="fas fa-pen"></i> Ghi l√¥</a>
        <a href="/lich-su"><i class="fas fa-history"></i> L·ªãch s·ª≠</a>
        <a href="/thong-ke" class="mobile-only"><i class="fas fa-chart-bar"></i> Th·ªëng k√™</a>
        <a href="/phan-tich" class="mobile-only"><i class="fas fa-brain"></i> Ph√¢n t√≠ch</a>
        <a href="/du_doan"><i class="fas fa-eye"></i> D·ª± ƒëo√°n</a>
        {% if user.role == 'admin' %}
        <a href="/admin/bank"><i class="fas fa-bank"></i> Qu·∫£n l√Ω ng√¢n h√†ng</a>
        <a href="/admin/users"><i class="fas fa-users-cog"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        {% endif %}
        <div class="user-info">
          <div class="user-row">
            <img src="{{ user.picture }}" class="avatar" alt="Avatar">
            <div class="user-name">{{ user.name }}</div>
          </div>
          <div class="user-balance">S·ªë d∆∞: {{ "{:,.0f}".format((user.balance | default(0))) }}VND</div>
          <a href="{{ url_for('dang_nhap.logout') }}" class="logout-btn">ƒêƒÉng xu·∫•t</a>
        </div>
      {% else %}
        <a href="/dang-nhap"><i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</a>
      {% endif %}
    </div>
  </div>
  <script>
    document.querySelector(".hamburger-btn").addEventListener("click", function () {
      document.getElementById("menu-items").classList.toggle("menu-hidden");
    });
  </script>

  <div class="layout">
    <!-- Sidebar tr√°i -->
    <div class="desktop-sidebar sticky-sidebar">
      <div class="sidebar-box">
        <div class="sidebar-section tk-box">
          <div class="section-title"><a href="/thong-ke" class="tk-link">üìä Th·ªëng k√™</a></div>
        </div>
        <div class="sidebar-section pt-box">
          <div class="section-title"><a href="/phan-tich" class="pt-link">üß† Ph√¢n t√≠ch</a></div>
        </div>
      </div>
    </div>

    <!-- N·ªôi dung ch√≠nh -->
    <main>
      <div class="tuan">
        {% for day in week_days %}
          <a href="/ket-qua{{ day.date_str }}" class="ngay-link {% if not day.available %}cho{% endif %}">
            {{ day.label }}
          </a>
        {% endfor %}
      </div>

      {% if result.is_waiting %}
        <p class="section-title" style="color: orange; font-weight: bold;">‚è≥ Ch∆∞a c√≥ k·∫øt qu·∫£ - Ch·ªù quay th∆∞·ªüng</p>
      {% endif %}
      <h1 class="section-title" style="color: red; padding-right: 40px">
        X·ªï s·ªë Mi·ªÅn B·∫Øc {{ result.date }}
      </h1>

      <div class="wrapper">
        <div class="bang-container">
          <table class="bang-kq">
            <tr><th>Gi·∫£i</th><th class="cot-ketqua">XSMB - K·∫øt qu·∫£ x·ªï s·ªë mi·ªÅn B·∫Øc - SXMB</th></tr>
            {% for giai, ds in result.ketqua.items() %}
            <tr class="{% if giai == 'ƒêB' %}giai-db{% elif giai == 'G7' %}giai-g7{% endif %}">
              <td class="giai">{{ giai }}</td>
              <td>
                <div class="so-container {% if ds|length == 6 %}so-container-6{% endif %}">
                  {% for so in ds %}
                    <div class="so {% if giai in ['ƒêB', 'G7'] %}do{% endif %}">{{ so }}</div>
                  {% endfor %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>

        <div class="bang-thongke">
          <table class="bang-kq-thongke">
            <thead><tr><th>ƒê·∫ßu</th><th>ƒêu√¥i</th></tr></thead>
            <tbody>
              {% for dau, duois in thong_ke.items() %}
              <tr>
                <td class="giai">{{ dau }}</td>
                <td>
                  <div class="so-container-nho">
                    {% for duoi in duois %}
                      <div class="so-nho">{{ duoi }}</div>
                    {% endfor %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      {% for item in past_results %}
      <h2 class="section-title" style="color: black; margin: 30px auto 20px auto;">K·∫øt qu·∫£ ng√†y {{ item.date }}</h2>
      <div class="wrapper">
        <div class="bang-container">
          <table class="bang-kq">
            <tr><th>Gi·∫£i</th><th class="cot-ketqu">XSMB - K·∫øt qu·∫£ x·ªï s·ªë mi·ªÅn B·∫Øc - SXMB</th></tr>
            {% for giai, ds in item.ketqua.items() %}
            <tr class="{% if giai == 'ƒêB' %}giai-db{% elif giai == 'G7' %}giai-g7{% endif %}">
              <td class="giai">{{ giai }}</td>
              <td>
                <div class="so-container {% if ds|length == 6 %}so-container-6{% endif %}">
                  {% for so in ds %}
                    <div class="so {% if giai in ['ƒêB', 'G7'] %}do{% endif %}">{{ so }}</div>
                  {% endfor %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>

        <div class="bang-thongke">
          <table class="bang-kq-thongke">
            <thead><tr><th>ƒê·∫ßu</th><th>ƒêu√¥i</th></tr></thead>
            <tbody>
              {% for dau, duois in item.thong_ke.items() %}
              <tr>
                <td class="giai">{{ dau }}</td>
                <td>
                  <div class="so-container-nho">
                    {% for duoi in duois %}
                      <div class="so-nho">{{ duoi }}</div>
                    {% endfor %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </main>

    <!-- Sidebar ph·∫£i -->
    {% if user %}
    <aside class="right-sidebar">
      <div class="top-bar">
        <div class="menu-item" onclick="showFeed()">
          <i class="fas fa-home fa-lg"></i>
        </div>
        <div class="menu-item" onclick="showFriends()">
          <i class="fas fa-user-friends fa-lg"></i>
        </div>
        <div class="menu-item" onclick="showNotifications()">
          <i class="fas fa-bell fa-lg"></i>
          <span id="notification-badge" class="badge" style="display: none;">0</span>
        </div>
        <div class="menu-item" onclick="showMessages()">
          <i class="fas fa-envelope fa-lg" style="position:relative;">
            <span id="message-badge" style="position:absolute; top:-5px; right:-5px; display:none; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:12px;"></span>
          </i>
        </div>
      </div>

      <!-- FEED -->
      <div class="feed-table" id="feed-table" style="display:block;">
        <div class="post-form">
          <textarea id="post-content" placeholder="B·∫°n ƒëang nghƒ© g√¨...?"></textarea>
          <button id="btn-post">ƒêƒÉng b√†i</button>
        </div>

        <div id="posts-container">
          {% if posts|length == 0 %}
            <p style="text-align:center; color: gray;">Ch∆∞a c√≥ b√†i vi·∫øt n√†o. H√£y ƒëƒÉng b√†i ƒë·∫ßu ti√™n!</p>
          {% else %}
            {% for post in posts %}
              <div class="post" data-id="{{ post._id }}" data-owner-id="{{ post.user_id }}">
                <img src="{{ post.user_picture }}" class="avatar">
                <b>{{ post.user_name }}</b>
                <div>{{ post.content }}</div>
                <small>{{ post.time }}</small>
                <div class="actions">
                  <button onclick="likePost('{{ post._id }}', this)"
                          class="{% if post.liked_by_current_user %}liked{% endif %}"
                          data-liked="{% if post.liked_by_current_user %}true{% else %}false{% endif %}">
                    Like ({{ post.likes | default(0) }})
                  </button>
                </div>
                <div class="comments-container">
                  {% for c in post.comments %}
                    <div class="comment"><b>{{ c.user_name }}</b>: {{ c.content }} <small>{{ c.time }}</small></div>
                  {% endfor %}
                </div>
                <input type="text" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
                       onkeydown="if(event.key==='Enter') commentPost('{{ post._id }}', this)">
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="friends-table" id="friends-container" style="display:none; padding: 10px;">
          <h3>Danh s√°ch b·∫°n b√®</h3>
          <input type="text" id="friend-search-input" placeholder="T√¨m ki·∫øm b·∫°n b√®..." style="width:100%; padding:4px; margin-bottom:5px;">
          <button id="friend-search-btn">T√¨m ki·∫øm</button>

          <div id="friend-search-results" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;"></div>
          
          <h4 style="margin-top:15px;">L·ªùi m·ªùi k·∫øt b·∫°n</h4>
          <div id="friend-requests" style="margin-bottom:15px;"></div>
          
          <h4>Danh s√°ch b·∫°n b√®</h4>
          <div id="friend-list"></div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="notifications" id="notifications-container">
        <h3>Th√¥ng b√°o</h3>
        <div id="notifications-list">
          {% if notifications|length == 0 %}
            <div class="notification">Ch∆∞a c√≥ th√¥ng b√°o n√†o</div>
          {% else %}
            {% for n in notifications %}
              <div class="notification {% if not n.seen %}unseen{% endif %}" 
                  data-id="{{ n._id }}"
                  data-type="{{ n.type }}"
                  data-post-id="{{ n.post_id }}"
                  data-from-user="{{ n.from_user_id }}"
                  onclick="handleNotificationClick(this)">
                <img src="{{ n.from_user_picture }}" onerror="this.src='/static/default-avatar.png'">
                <div class="notification-content">
                  <div><b>{{ n.from_user_name }}</b> 
                    {% if n.type == 'like' %}
                      ƒë√£ th√≠ch b√†i vi·∫øt c·ªßa b·∫°n
                    {% elif n.type == 'comment' %}
                      ƒë√£ b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt c·ªßa b·∫°n: "{{ n.content|truncate(30) }}"
                    {% elif n.type == 'friend_request' %}
                      mu·ªën k·∫øt b·∫°n v·ªõi b·∫°n
                    {% elif n.type == 'friend_accept' %}
                      ƒë√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n c·ªßa b·∫°n
                    {% endif %}
                  </div>
                  <div class="notification-time">{{ n.time }}</div>
                  {% if n.type == 'friend_request' %}
                  <div class="notification-actions">
                    <button class="accept-btn" onclick="acceptFriendRequest('{{ n.from_user_id }}', event)">Ch·∫•p nh·∫≠n</button>
                    <button class="reject-btn" onclick="rejectFriendRequest('{{ n.from_user_id }}', event)">T·ª´ ch·ªëi</button>
                  </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="messages-container" id="messages-container" style="display:none; padding:10px;">
        <h3>Tin nh·∫Øn</h3>
        
        <!-- Danh s√°ch h·ªôi tho·∫°i -->
        <div id="conversation-list"></div>
        
        <!-- Khung chat (·∫©n ban ƒë·∫ßu) -->
        <div id="active-chat" class="conversation-view">
          <div class="chat-container">
            <div class="chat-header">
              <button class="back-button" onclick="backToConversationList()">‚Üê</button>
              <img id="chat-user-avatar" src="/static/default-avatar.png" style="width:40px;height:40px;border-radius:50%;margin-right:10px;">
              <div>
                <h4 id="chat-user-name" style="margin:0;">T√™n ng∆∞·ªùi d√πng</h4>
                <small id="chat-user-status" style="color:#666; font-size:12px;">ƒêang ho·∫°t ƒë·ªông</small>
              </div>
            </div>
            <div class="chat-messages" id="chat-box"></div>
            <div class="chat-input-container">
              <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." 
                    onkeydown="if(event.key==='Enter') sendChatMessage()"
                    oninput="sendTyping(true)">
              <button onclick="sendChatMessage()" style="padding:8px 16px; background:#0084ff; color:white; border:none; border-radius:20px; margin-left:8px; cursor:pointer;">G·ª≠i</button>
            </div>
            <div id="typing-status" style="font-size:12px;color:gray;margin-top:5px;padding:0 10px;"></div>
          </div>
        </div>
      </div>
    </aside>
    {% endif %}
  </div>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p>H·ªá th·ªëng d·ª± ƒëo√°n XSMB &copy; 2024 - Ph√°t tri·ªÉn b·ªüi AI Analysis Team</p>
        </div>
    </footer>

<script>
// ===== QU·∫¢N L√ù TAB =====
function showFeed(){
  document.getElementById('feed-table').style.display = 'block';
  document.getElementById('notifications-container').style.display = 'none';
  document.getElementById('friends-container').style.display = 'none';
  document.getElementById('messages-container').style.display = 'none';

  const posts = document.querySelectorAll('#posts-container .post');
  posts.forEach(p => {
    p.style.display = "block";
    p.classList.remove("highlight-post");
  });
}

function showFriends(){
  document.getElementById('feed-table').style.display = 'none';
  document.getElementById('notifications-container').style.display = 'none';
  document.getElementById('friends-container').style.display = 'block';
  document.getElementById('messages-container').style.display = 'none';
  loadFriends();
}

function showNotifications(){
  document.getElementById('feed-table').style.display = 'none';
  document.getElementById('friends-container').style.display = 'none';
  document.getElementById('notifications-container').style.display = 'block';
  document.getElementById('messages-container').style.display = 'none';
  updateNotificationBadge();
}

function showMessages(){
  document.getElementById('feed-table').style.display = 'none';
  document.getElementById('friends-container').style.display = 'none';
  document.getElementById('notifications-container').style.display = 'none';
  document.getElementById('messages-container').style.display = 'block';
  loadConversations();
}

const socket = io();
const currentUserId = "{{ user._id|string }}";
socket.on("connect", () => console.log("Socket connected!"));
// Khi server emit s·ª± ki·ªán new_result
socket.on("new_result", (data) => {
  console.log("üì© Nh·∫≠n k·∫øt qu·∫£ m·ªõi:", data);

  // v√≠ d·ª• c·∫≠p nh·∫≠t th·∫ª hi·ªÉn th·ªã k·∫øt qu·∫£
  const resultsDiv = document.getElementById("realtime-results");

  if (resultsDiv) {
    resultsDiv.innerHTML = `
      <h3>K·∫øt qu·∫£ XSMB ng√†y ${data.date}</h3>
      <p><strong>ƒêB:</strong> ${data.ketqua["ƒêB"].join(", ")}</p>
      <p><strong>G1:</strong> ${data.ketqua["G1"].join(", ")}</p>
      <p><strong>G2:</strong> ${data.ketqua["G2"].join(", ")}</p>
      <p><strong>G3:</strong> ${data.ketqua["G3"].join(", ")}</p>
      <p><strong>G4:</strong> ${data.ketqua["G4"].join(", ")}</p>
      <p><strong>G5:</strong> ${data.ketqua["G5"].join(", ")}</p>
      <p><strong>G6:</strong> ${data.ketqua["G6"].join(", ")}</p>
      <p><strong>G7:</strong> ${data.ketqua["G7"].join(", ")}</p>
    `;
  }
});

socket.on("connect_error", err => console.log("Socket connection error:", err));
let currentChatPeer = null;
let typingTimeout = null;
let seenMsgIds = new Set();
let unreadCount = 0;
let conversations = [];
let friends = [];
let pendingNotifications = []; // M·∫£ng l∆∞u th√¥ng b√°o ch∆∞a hi·ªÉn th·ªã

// =====================
// Hi·ªÉn th·ªã tab th√¥ng b√°o - LOAD T·∫§T C·∫¢ TH√îNG B√ÅO
// =====================
function showNotifications(){
  document.getElementById('feed-table').style.display = 'none';
  document.getElementById('friends-container').style.display = 'none';
  document.getElementById('notifications-container').style.display = 'block';
  document.getElementById('messages-container').style.display = 'none';
  
  // Hi·ªÉn th·ªã t·∫•t c·∫£ th√¥ng b√°o pending khi chuy·ªÉn sang tab
  if (pendingNotifications.length > 0) {
    pendingNotifications.forEach(notification => {
      addNotificationToUI(notification, true);
    });
    pendingNotifications = [];
  }
  
  updateNotificationBadge();
}
// =====================
// S·∫Øp x·∫øp th√¥ng b√°o theo th·ªùi gian (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
// =====================
function sortNotificationsByTime() {
  const notificationsList = document.getElementById("notifications-list");
  if (!notificationsList) return;
  
  const notifications = Array.from(notificationsList.children);
  
  notifications.sort((a, b) => {
    const timeA = a.querySelector('.notification-time').textContent;
    const timeB = b.querySelector('.notification-time').textContent;
    return new Date(timeB) - new Date(timeA);
  });
  
  // X√≥a v√† th√™m l·∫°i theo th·ª© t·ª± m·ªõi
  notifications.forEach(notification => {
    notificationsList.appendChild(notification);
  });
}
// =====================
// H√†m th√™m th√¥ng b√°o v√†o UI
// =====================
function addNotificationToUI(notification, isNew = false) {
  const notificationsList = document.getElementById("notifications-list");
  if (!notificationsList) return;
  
  // X√≥a th√¥ng b√°o "Ch∆∞a c√≥ th√¥ng b√°o n√†o" n·∫øu c√≥
  if (notificationsList.textContent.includes("Ch∆∞a c√≥ th√¥ng b√°o n√†o")) {
    notificationsList.innerHTML = '';
  }
  
  const notificationEl = document.createElement("div");
  notificationEl.className = `notification ${isNew ? 'unseen' : ''}`;
  notificationEl.setAttribute("data-id", notification._id);
  notificationEl.setAttribute("data-type", notification.type);
  notificationEl.setAttribute("data-post-id", notification.post_id || '');
  notificationEl.setAttribute("data-from-user", notification.from_user_id);
  notificationEl.onclick = function() { handleNotificationClick(this); };
  
  let actionContent = '';
  let messageContent = '';
  
  // X√°c ƒë·ªãnh n·ªôi dung th√¥ng b√°o
  switch(notification.type) {
    case 'like':
      messageContent = 'ƒë√£ th√≠ch b√†i vi·∫øt c·ªßa b·∫°n';
      break;
    case 'comment':
      const commentText = notification.content ? 
        'ƒë√£ b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt c·ªßa b·∫°n: "' + (notification.content.length > 30 ? notification.content.substring(0, 30) + '...' : notification.content) + '"' : 
        'ƒë√£ b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt c·ªßa b·∫°n';
      messageContent = commentText;
      break;
    case 'friend_request':
      messageContent = 'mu·ªën k·∫øt b·∫°n v·ªõi b·∫°n';
      actionContent = `
        <div class="notification-actions">
          <button class="accept-btn" onclick="acceptFriendRequest('${notification.from_user_id}', event)">Ch·∫•p nh·∫≠n</button>
          <button class="reject-btn" onclick="rejectFriendRequest('${notification.from_user_id}', event)">T·ª´ ch·ªëi</button>
        </div>
      `;
      break;
    case 'friend_accept':
      messageContent = 'ƒë√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n c·ªßa b·∫°n';
      break;
  }
  
  notificationEl.innerHTML = `
    <img src="${notification.from_user_picture || '/static/default-avatar.png'}" onerror="this.src='/static/default-avatar.png'" style="width:40px;height:40px;border-radius:50%;">
    <div class="notification-content">
      <div><b>${notification.from_user_name}</b> ${messageContent}</div>
      <div class="notification-time">${notification.time}</div>
      ${actionContent}
    </div>
  `;
  
  // LU√îN TH√äM V√ÄO ƒê·∫¶U DANH S√ÅCH (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
  if (notificationsList.firstChild) {
    notificationsList.insertBefore(notificationEl, notificationsList.firstChild);
  } else {
    notificationsList.appendChild(notificationEl);
  }
  // C·∫≠p nh·∫≠t badge sau khi th√™m th√¥ng b√°o
  updateNotificationBadge();
}
// =====================
// X·ª≠ l√Ω click th√¥ng b√°o
// =====================
function handleNotificationClick(notificationEl) {
  const type = notificationEl.getAttribute('data-type');
  const postId = notificationEl.getAttribute('data-post-id');
  const fromUserId = notificationEl.getAttribute('data-from-user');
  const notificationId = notificationEl.getAttribute('data-id');
  
  // ƒê√°nh d·∫•u ƒë√£ xem
  socket.emit("mark_notification_seen", { notification_id: notificationId });
  notificationEl.classList.remove("unseen");
  
  // X·ª≠ l√Ω theo lo·∫°i th√¥ng b√°o
  if (type === 'like' || type === 'comment') {
    if (postId) {
      // Chuy·ªÉn ƒë·∫øn tab feed v√† highlight b√†i vi·∫øt
      showFeed();
      
      // T√¨m b√†i vi·∫øt v√† highlight
      const postElement = document.querySelector(`.post[data-id="${postId}"]`);
      if (postElement) {
        postElement.scrollIntoView({ behavior: 'smooth' });
        postElement.classList.add("highlight-post");
        setTimeout(() => {
          postElement.classList.remove("highlight-post");
        }, 3000);
      } else {
        alert("B√†i vi·∫øt kh√¥ng c√≤n t·ªìn t·∫°i");
      }
    }
  } else if (type === 'friend_request' || type === 'friend_accept') {
    // Chuy·ªÉn ƒë·∫øn tab b·∫°n b√®
    showFriends();
  }
  
  // C·∫≠p nh·∫≠t badge
  updateNotificationBadge();
}

// D·ª´ng s·ª± ki·ªán click khi nh·∫•n v√†o n√∫t trong th√¥ng b√°o
function acceptFriendRequest(userId, event) {
  event.stopPropagation();
  socket.emit("accept_friend", { from_user_id: userId });
}

function rejectFriendRequest(userId, event) {
  event.stopPropagation();
  socket.emit("reject_friend", { from_user_id: userId });
}

// =====================
// C·∫≠p nh·∫≠t badge th√¥ng b√°o
// =====================
function updateNotificationBadge() {
  const unseenElements = document.querySelectorAll('.notification.unseen');
  const unseenCount = unseenElements.length + pendingNotifications.length;
  const badge = document.getElementById("notification-badge");
  console.log(`C·∫≠p nh·∫≠t badge: ${unseenCount} th√¥ng b√°o ch∆∞a ƒë·ªçc`);
  if (unseenCount > 0) {
    badge.style.display = "inline";
    badge.textContent = unseenCount > 99 ? "99+" : unseenCount;
  } else {
    badge.style.display = "none";
  }
}

// =====================
// C·∫¨P NH·∫¨T BADGE TIN NH·∫ÆN
// =====================
function updateMessageBadge() {
  const badge = document.getElementById("message-badge");
  if (!badge) return;
  
  const totalUnread = conversations.reduce((total, conv) => total + (conv.unread_count || 0), 0);
  
  if (totalUnread > 0) {
    badge.style.display = "inline";
    badge.textContent = totalUnread > 99 ? "99+" : totalUnread;
  } else {
    badge.style.display = "none";
  }
}

// =====================
// Th√¥ng b√°o m·ªõi t·ª´ server - X·ª¨ L√ù REAL-TIME
// =====================
socket.on("new_notification", notification => {
  console.log("Nh·∫≠n th√¥ng b√°o m·ªõi:", notification);
  
  // CH·ªà x·ª≠ l√Ω th√¥ng b√°o n·∫øu n√≥ d√†nh cho user hi·ªán t·∫°i
  if (notification.to_user_id && notification.to_user_id !== currentUserId) {
    console.log("B·ªè qua th√¥ng b√°o kh√¥ng d√†nh cho user hi·ªán t·∫°i");
    return;
  }
  
  // Ki·ªÉm tra xem ƒëang ·ªü tab th√¥ng b√°o hay kh√¥ng
  const isNotificationTab = document.getElementById('notifications-container').style.display === 'block';
  
  if (isNotificationTab) {
    // N·∫øu ƒëang ·ªü tab th√¥ng b√°o, th√™m ngay v√†o UI
    addNotificationToUI(notification, true);
  } else {
    // N·∫øu kh√¥ng ·ªü tab th√¥ng b√°o, l∆∞u v√†o m·∫£ng pending
    pendingNotifications.push(notification);
    
    // Hi·ªÉn th·ªã toast notification
    showToastNotification(notification);
    // C·∫≠p nh·∫≠t badge l·∫°i ƒë·ªÉ bao g·ªìm pending
    updateNotificationBadge();
  }
});
// =====================
// Hi·ªÉn th·ªã toast notification
// =====================
function showToastNotification(notification) {
  let message = '';
  
  switch(notification.type) {
    case 'like':
      message = `${notification.from_user_name} ƒë√£ th√≠ch b√†i vi·∫øt c·ªßa b·∫°n`;
      break;
    case 'comment':
      message = `${notification.from_user_name} ƒë√£ b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt c·ªßa b·∫°n`;
      break;
    case 'friend_request':
      message = `${notification.from_user_name} mu·ªën k·∫øt b·∫°n v·ªõi b·∫°n`;
      break;
    case 'friend_accept':
      message = `${notification.from_user_name} ƒë√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n`;
      break;
    default:
      message = `B·∫°n c√≥ th√¥ng b√°o m·ªõi t·ª´ ${notification.from_user_name}`;
  }
  
  const toast = document.createElement("div");
  toast.className = "toast-notification";
  toast.innerHTML = `
    <div style="font-weight: bold;">Th√¥ng b√°o m·ªõi</div>
    <div>${message}</div>
    <small>${notification.time}</small>
  `;
  
  toast.style.cursor = "pointer";
  toast.onclick = function() {
    showNotifications();
    this.remove();
  };
  
  document.body.appendChild(toast);
  
  // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 5000);
}
// =====================
// G·ª≠i th√¥ng b√°o - S·ª¨A L·∫†I ƒë·ªÉ ch·ªâ g·ª≠i ƒë·∫øn user nh·∫≠n
// =====================
function sendNotification(type, toUserId, postId = null, content = null) {
  // CH·ªà g·ª≠i th√¥ng b√°o n·∫øu ng∆∞·ªùi nh·∫≠n kh√¥ng ph·∫£i l√† ch√≠nh m√¨nh
  if (toUserId === currentUserId) {
    console.log("Kh√¥ng g·ª≠i th√¥ng b√°o cho ch√≠nh m√¨nh");
    return;
  }
  
  socket.emit("send_notification", {
    type: type,
    post_id: postId,
    content: content,
    to_user_id: toUserId,  // QUAN TR·ªåNG: ch·ªâ g·ª≠i ƒë·∫øn user nh·∫≠n
    from_user_id: currentUserId,
    from_user_name: "{{ user.name }}",
    from_user_picture: "{{ user.picture }}"
  });
}
// =====================
// Post m·ªõi t·ª´ server
// =====================
socket.on("new_post", post => {
  const container = document.getElementById("posts-container");
  if(!container) return;
  
  const div = document.createElement("div");
  div.className = "post highlight-post";
  div.dataset.id = post._id;
  div.innerHTML = `
    <img src="${post.user_picture}" class="avatar">
    <b>${post.user_name}</b>
    <div>${post.content}</div>
    <small>${post.time}</small>
    <div class="actions">
      <button onclick="likePost('${post._id}', this)" data-liked="false">Like (0)</button>
    </div>
    <div class="comments-container"></div>
    <input type="text" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." 
          onkeydown="if(event.key==='Enter') commentPost('${post._id}', this)">
  `;
  container.prepend(div);
  setTimeout(() => div.classList.remove("highlight-post"), 3000);
});

// =====================
// Like post
// =====================
function likePost(postId, button) {
  // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
  const isLiked = button.getAttribute('data-liked') === 'true';
  const currentLikes = parseInt(button.textContent.match(/\d+/)[0]);
  
  if (isLiked) {
    // Unlike
    button.classList.remove("liked");
    button.setAttribute("data-liked", "false");
    button.textContent = 'Like (' + (currentLikes - 1) + ')';
  } else {
    // Like
    button.classList.add("liked");
    button.setAttribute("data-liked", "true");
    button.textContent = 'Like (' + (currentLikes + 1) + ')';
    // G·ª≠i th√¥ng b√°o - l·∫•y user_id c·ªßa ch·ªß b√†i vi·∫øt
    const postElement = document.querySelector('.post[data-id="' + postId + '"]');
    const postOwnerId = postElement ? postElement.getAttribute('data-owner-id') : null;

    if (postOwnerId && postOwnerId !== currentUserId) {
        sendNotification("like", postOwnerId, postId);
    }
  }
  // G·ª≠i s·ª± ki·ªán ƒë·∫øn server
  socket.emit("like_post", { post_id: postId, user_id: currentUserId });
}




socket.on("update_like", data => {
  const postElement = document.querySelector(`.post[data-id="${data.post_id}"]`);
  if (!postElement) return;
  
  const likeButton = postElement.querySelector('.actions button');
  if (likeButton) {
    likeButton.textContent = 'Like (' + data.likes + ')';
    
    // Ch·ªâ c·∫≠p nh·∫≠t tr·∫°ng th√°i like cho user hi·ªán t·∫°i
    if (data.user_id === currentUserId) {
      if (data.liked) {
        likeButton.classList.add("liked");
        likeButton.setAttribute("data-liked", "true");
      } else {
        likeButton.classList.remove("liked");
        likeButton.setAttribute("data-liked", "false");
      }
    }
  }
});

// =====================
// Comment post
// =====================
function commentPost(postId, input) {
  if(!currentUserId) {
    alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n.");
    return;
  }
  
  const content = input.value.trim();
  if(!content) return;
  
  socket.emit("comment_post", {
    user_id: currentUserId,
    user_name: "{{ user.name }}",
    user_picture: "{{ user.picture }}",
    post_id: postId,
    content: content
  });
  
  // G·ª≠i th√¥ng b√°o - l·∫•y user_id c·ªßa ch·ªß b√†i vi·∫øt
  const postElement = document.querySelector('.post[data-id="' + postId + '"]');
  const postOwnerId = postElement ? postElement.getAttribute('data-owner-id') : null;
  
  if (postOwnerId && postOwnerId !== currentUserId) {
    sendNotification("comment", postOwnerId, postId, content);
  }
  
  input.value = "";
}


socket.on("new_comment", data => {
  const postEl = document.querySelector(`.post[data-id="${data.post_id}"] .comments-container`);
  if(postEl) {
    const c = data.comment;
    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `<b>${c.user_name}</b>: ${c.content} <small>${c.time}</small>`;
    postEl.appendChild(div);
  }
});

// =====================
// ƒêƒÉng b√†i
// =====================
const btnPost = document.getElementById('btn-post');
if(btnPost){
  btnPost.addEventListener('click', function(){
    const contentEl = document.getElementById('post-content');
    const content = (contentEl.value || '').trim();
    if(!content) return alert('N·ªôi dung b√†i vi·∫øt kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
    socket.emit("post_feed", {
      user_id: currentUserId,
      user_name: "{{ user.name }}",
      user_picture: "{{ user.picture }}",
      content: content
    });
    contentEl.value = "";
  });
}

// =====================
// G·ª¨I L·ªúI M·ªúI K·∫æT B·∫†N
// =====================
function sendFriendRequest(userId) {
  socket.emit("send_friend_request", { to_user_id: userId });
  
  // G·ª≠i th√¥ng b√°o
  sendNotification("friend_request", userId);
}

// X·ª≠ l√Ω khi g·ª≠i l·ªùi m·ªùi th√†nh c√¥ng
socket.on("friend_request_sent", data => {
  // C·∫≠p nh·∫≠t n√∫t tr√™n k·∫øt qu·∫£ t√¨m ki·∫øm
  const btn = document.querySelector(`#friend-search-results button[data-id='${data.to_user_id}']`);
  if (btn) {
    btn.innerText = "ƒê√£ g·ª≠i l·ªùi m·ªùi";
    btn.disabled = true;
    btn.classList.add("pending");
    btn.onclick = null;
  }
});

// =====================
// TH√äM L·ªúI M·ªúI V√ÄO DANH S√ÅCH
// =====================
function addFriendRequest(userId, userName) {
  const requestsContainer = document.getElementById("friend-requests");
  const existingRequest = document.getElementById(`req-${userId}`);
  
  if (existingRequest) {
    existingRequest.remove();
  }
  
  const div = document.createElement("div");
  div.id = `req-${userId}`;
  div.className = "request-item";
  div.innerHTML = `
    <div>
      <img src="/static/default-avatar.png" style="width:30px;height:30px;border-radius:50%;margin-right:8px;">
      <span>${userName} ƒë√£ g·ª≠i l·ªùi m·ªùi</span>
    </div>
    <div>
      <button onclick="acceptFriend('${userId}')">Ch·∫•p nh·∫≠n</button>
      <button onclick="rejectFriend('${userId}')">T·ª´ ch·ªëi</button>
    </div>
  `;
  requestsContainer.appendChild(div);
}

// =====================
// CH·∫§P NH·∫¨N K·∫æT B·∫†N
// =====================
function acceptFriend(userId, event) {
  event.stopPropagation();
  // Ki·ªÉm tra xem ƒë√£ c√≥ trong danh s√°ch b·∫°n b√® ch∆∞a
  const existingFriend = document.querySelector(`#friend-list div[data-id='${userId}']`);
  if (existingFriend) {
      alert("Ng∆∞·ªùi n√†y ƒë√£ l√† b·∫°n b√® c·ªßa b·∫°n");
      // X√≥a th√¥ng b√°o k·∫øt b·∫°n
      const requestDiv = document.getElementById(`req-${userId}`);
      if (requestDiv) {
          requestDiv.remove();
      }
      return;
  }
  
  socket.emit("accept_friend", { from_user_id: userId });
}

// X·ª≠ l√Ω khi k·∫øt b·∫°n th√†nh c√¥ng
socket.on("friend_added", data => {
  console.log("Th√™m b·∫°n th√†nh c√¥ng:", data);
  // X√≥a kh·ªèi danh s√°ch l·ªùi m·ªùi
  const requestDiv = document.getElementById(`req-${data.friend_id}`);
  if (requestDiv) {
    requestDiv.remove();
  }
  
  // Ki·ªÉm tra xem ƒë√£ c√≥ trong danh s√°ch b·∫°n b√® ch∆∞a tr∆∞·ªõc khi th√™m
  const existingFriend = document.querySelector(`#friend-list div[data-id='${data.friend_id}']`);
  if (!existingFriend) {
      // Th√™m v√†o danh s√°ch b·∫°n b√®
      addFriendToList(data.friend_id, data.friend_name, data.friend_picture);
  }
  // C·∫≠p nh·∫≠t badge th√¥ng b√°o
  updateNotificationBadge();
});
// X·ª≠ l√Ω l·ªói k·∫øt b·∫°n
socket.on("error", data => {
    console.log("L·ªói k·∫øt b·∫°n:", data);
    
    if (data.error === "ALREADY_FRIENDS") {
        alert("Ng∆∞·ªùi n√†y ƒë√£ l√† b·∫°n b√® c·ªßa b·∫°n");
        // X√≥a th√¥ng b√°o k·∫øt b·∫°n
        const requestDiv = document.getElementById(`req-${data.from_user_id}`);
        if (requestDiv) {
            requestDiv.remove();
        }
        updateNotificationBadge();
    } else if (data.error === "NO_FRIEND_REQUEST") {
        alert("Kh√¥ng t√¨m th·∫•y l·ªùi m·ªùi k·∫øt b·∫°n");
        const requestDiv = document.getElementById(`req-${data.from_user_id}`);
        if (requestDiv) {
            requestDiv.remove();
        }
        updateNotificationBadge();
    } else if (data.error === "ALREADY_REQUESTED") {
        alert("ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n tr∆∞·ªõc ƒë√≥");
    }
});
// =====================
// TH√äM B·∫†N V√ÄO DANH S√ÅCH
// =====================
function addFriendToList(friendId, friendName, friendPicture) {
  const friendList = document.getElementById("friend-list");
  const existingFriend = document.querySelector(`#friend-list div[data-id='${friendId}']`);
  
  if (existingFriend) {
    existingFriend.remove();
  }
  
  const div = document.createElement("div");
  div.className = "friend-item";
  div.dataset.id = friendId;
  div.innerHTML = `
    <div style="display:flex;align-items:center;">
      <img src="${friendPicture || '/static/default-avatar.png'}" style="width:30px;height:30px;border-radius:50%;margin-right:8px;">
      <b>${friendName}</b>
    </div>
    <div>
      <button onclick="openChatWindow({ _id:'${friendId}', name:'${friendName}', picture:'${friendPicture}' })">Chat</button>
      <button onclick="removeFriend('${friendId}')">X√≥a</button>
    </div>
  `;
  friendList.appendChild(div);
}

// =====================
// X√ìA B·∫†N
// =====================
function removeFriend(friendId) {
  if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi n√†y kh·ªèi danh s√°ch b·∫°n b√®?")) {
    socket.emit("remove_friend", { friend_id: friendId });
  }
}

// X·ª≠ l√Ω khi x√≥a b·∫°n th√†nh c√¥ng
socket.on("friend_removed", data => {
  // X√≥a kh·ªèi danh s√°ch b·∫°n b√®
  const friendDiv = document.querySelector(`#friend-list div[data-id='${data.friend_id}']`);
  if (friendDiv) {
    friendDiv.remove();
  }
  
  // N·∫øu ƒëang chat v·ªõi ng∆∞·ªùi n√†y, ƒë√≥ng chat
  if (currentChatPeer === data.friend_id) {
    currentChatPeer = null;
    document.getElementById("messages-container").innerHTML = "<h3>Tin nh·∫Øn</h3><div id='conversations'></div>";
  }
});

function rejectFriend(userId) {
  socket.emit("reject_friend", { from_user_id: userId });
}

// X·ª≠ l√Ω khi t·ª´ ch·ªëi th√†nh c√¥ng
socket.on("friend_rejected", data => {
  const requestDiv = document.getElementById(`req-${data.from_user_id}`);
  if (requestDiv) {
    requestDiv.remove();
  }
});

// =====================
// T·∫¢I DANH S√ÅCH B·∫†N B√à
// =====================
function loadFriends() {
  socket.emit("get_friends");
  socket.emit("get_friend_requests");
}

// =====================
// C·∫¨P NH·∫¨T GIAO DI·ªÜN KHI T√åM KI·∫æM
// =====================
socket.on("search_results", results => {
  const container = document.getElementById("friend-search-results");
  container.innerHTML = "";
  
  results.forEach(user => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.marginBottom = "8px";
    div.innerHTML = `
      <img src="${user.picture || '/static/default-avatar.png'}" style="width:30px;height:30px;border-radius:50%;margin-right:8px;">
      <b>${user.name || user.username || user._id}</b>
      <button data-id="${user._id}" onclick="sendFriendRequest('${user._id}')" style="margin-left:auto;">K·∫øt b·∫°n</button>
    `;
    container.appendChild(div);
  });
});

// X·ª≠ l√Ω danh s√°ch b·∫°n b√® t·ª´ server
socket.on("friends_list", friendsData => {
  friends = friendsData;
  const container = document.getElementById("friend-list");
  container.innerHTML = "";
  
  friendsData.forEach(friend => {
    const div = document.createElement("div");
    div.className = "friend-item";
    div.dataset.id = friend._id;
    div.innerHTML = `
      <div class="friend-info">
        <img src="${friend.picture || '/static/default-avatar.png'}" style="width:40px;height:40px;border-radius:50%;margin-right:10px;">
        <div>
          <b>${friend.name || friend.username || friend._id}</b>
        </div>
      </div>
      <div class="friend-actions">
        <button onclick="openChatWindow({ _id:'${friend._id}', name:'${friend.name || friend.username}', picture:'${friend.picture}' })">Chat</button>
        <button onclick="removeFriend('${friend._id}')">X√≥a</button>
      </div>
    `;
    container.appendChild(div);
  });
});

// X·ª≠ l√Ω danh s√°ch l·ªùi m·ªùi k·∫øt b·∫°n
socket.on("friend_requests_list", requests => {
  const container = document.getElementById("friend-requests");
  container.innerHTML = "";
  
  requests.forEach(req => {
    const div = document.createElement("div");
    div.id = `req-${req.from_user_id}`;
    div.className = "request-item";
    div.innerHTML = `
      <div style="display:flex;align-items:center;">
        <img src="${req.from_user_picture || '/static/default-avatar.png'}" style="width:30px;height:30px;border-radius:50%;margin-right:8px;">
        <span>${req.from_user_name} ƒë√£ g·ª≠i l·ªùi m·ªùi</span>
      </div>
      <div>
        <button onclick="acceptFriend('${req.from_user_id}')">Ch·∫•p nh·∫≠n</button>
        <button onclick="rejectFriend('${req.from_user_id}')">T·ª´ ch·ªëi</button>
      </div>
    `;
    container.appendChild(div);
  });
});

// X·ª≠ l√Ω k·∫øt qu·∫£ t√¨m ki·∫øm
document.getElementById("friend-search-btn").addEventListener("click", function() {
  const keyword = document.getElementById("friend-search-input").value.trim();
  if (keyword) {
    socket.emit("search_users", { keyword: keyword });
  }
});

// =====================
// T·∫¢I DANH S√ÅCH H·ªòI THO·∫†I
// =====================
function loadConversations() {
  socket.emit("get_conversations");
}

// L·∫ÆNG NGHE PH·∫¢N H·ªíI DANH S√ÅCH H·ªòI THO·∫†I T·ª™ SERVER
socket.on("conversations_list", (conversationsData) => {
  conversations = conversationsData;
  updateMessageBadge();
  renderConversationList();
});

// =====================
// HI·ªÇN TH·ªä DANH S√ÅCH H·ªòI THO·∫†I
// =====================
function renderConversationList() {
  const container = document.getElementById('conversation-list');
  if (!container) return;
  
  if (!currentChatPeer) {
    document.getElementById('active-chat').classList.remove('active-conversation');
    container.style.display = 'block';
  }
  
  if (conversations.length === 0) {
    container.innerHTML = '<div class="empty-chat"><i class="fas fa-comments fa-3x"></i><p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p></div>';
    return;
  }
  
  // S·∫Øp x·∫øp h·ªôi tho·∫°i: c√≥ tin nh·∫Øn ch∆∞a ƒë·ªçc l√™n ƒë·∫ßu, sau ƒë√≥ theo th·ªùi gian
  const sortedConversations = [...conversations].sort((a, b) => {
    if (a.unread_count > 0 && b.unread_count === 0) return -1;
    if (a.unread_count === 0 && b.unread_count > 0) return 1;
    
    const aTime = new Date(a.last_message_time || 0);
    const bTime = new Date(b.last_message_time || 0);
    return bTime - aTime;
  });
  
  let html = '<div class="conversation-list">';
  
  sortedConversations.forEach(conv => {
    const isActive = currentChatPeer === conv.user_id;
    const unread = conv.unread_count > 0 ? `<span class="unread-count">${conv.unread_count}</span>` : '';
    const lastTime = conv.last_message_time ? formatTime(new Date(conv.last_message_time)) : '';
    
    html += `
      <div class="conversation-item ${isActive ? 'active' : ''}" data-id="${conv.user_id}" onclick="selectConversation('${conv.user_id}')">
        <img src="${conv.picture || '/static/default-avatar.png'}" style="width:50px;height:50px;border-radius:50%;" onerror="this.src='/static/default-avatar.png'">
        <div class="conversation-info">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div class="conversation-name">${conv.name}</div>
            <div class="conversation-time">${lastTime}</div>
          </div>
          <div class="conversation-preview">${conv.last_message || 'Ch∆∞a c√≥ tin nh·∫Øn'}</div>
        </div>
        ${unread}
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// =====================
// ƒê·ªäNH D·∫†NG TH·ªúI GIAN
// =====================
function formatTime(dateString) {
  if (!dateString) return '';
  
  try {
    let date = new Date(dateString);
    
    if (isNaN(date.getTime())) {
      if (dateString.indexOf('+') === -1 && dateString.indexOf('Z') === -1) {
        date = new Date(dateString + '+07:00');
      } else {
        date = new Date(dateString);
      }
    }
    
    if (isNaN(date.getTime())) return '';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    const formatTime = () => {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    };
    
    if (diffMins < 1) return 'V·ª´a xong';
    if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
    if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
    if (diffDays === 1) return `H√¥m qua, ${formatTime()}`;
    if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}, ${formatTime()}`;
    
  } catch (e) {
    console.error('Error formatting time:', e, dateString);
    return '';
  }
}

// =====================
// QUAY L·∫†I DANH S√ÅCH H·ªòI THO·∫†I
// =====================
function backToConversationList() {
  document.getElementById('active-chat').classList.remove('active-conversation');
  document.getElementById('conversation-list').style.display = 'block';
  currentChatPeer = null;
  renderConversationList();
}

// =====================
// CH·ªåN CU·ªòC TR√í CHUY·ªÜN T·ª™ DANH S√ÅCH
// =====================
function selectConversation(userId) {
  const conversation = conversations.find(c => c.user_id === userId);
  if (!conversation) return;
  
  socket.emit("mark_seen", {peer_id: userId});
  
  const convIndex = conversations.findIndex(c => c.user_id === userId);
  if (convIndex !== -1) {
    conversations[convIndex].unread_count = 0;
    updateMessageBadge();
    renderConversationList();
  }
  
  openChatWindow({
    _id: conversation.user_id,
    name: conversation.name,
    picture: conversation.picture
  });
}

// =====================
// M·ªû CHAT T·ª™ TRANG B·∫†N B√à HO·∫∂C DANH S√ÅCH H·ªòI THO·∫†I
// =====================
function openChatWindow(friend) {
  showMessages();
  
  currentChatPeer = String(friend._id);
  seenMsgIds.clear();
  
  const conversationIndex = conversations.findIndex(c => c.user_id === friend._id);
  if (conversationIndex !== -1 && conversations[conversationIndex].unread_count > 0) {
    conversations[conversationIndex].unread_count = 0;
    updateMessageBadge();
    renderConversationList();
  }
  
  document.getElementById('conversation-list').style.display = 'none';
  document.getElementById('active-chat').classList.add('active-conversation');
  
  document.getElementById('chat-user-avatar').src = friend.picture || '/static/default-avatar.png';
  document.getElementById('chat-user-name').textContent = friend.name || friend.username || friend._id;
  
  const chatBox = document.getElementById("chat-box");
  chatBox.innerHTML = "";

  socket.emit("join", { peer_id: friend._id });
}

// =====================
// X·ª¨ L√ù TIN NH·∫ÆN T·ª™ SERVER
// =====================
socket.on("joined", data => {
  const chatBox = document.getElementById("chat-box");
  if(!chatBox) return;
  
  chatBox.innerHTML = "";
  data.history.forEach(msg => appendMessage(msg));
  scrollChatToBottom();
});

socket.on("message", msg => {
  const isMe = String(msg.sender_id) === String(currentUserId);
  const senderId = String(msg.sender_id);
  
  updateConversationList(msg, isMe);
  
  if (currentChatPeer === senderId) {
    appendMessage(msg);
    socket.emit("mark_seen", {peer_id: senderId});
  } else if (!isMe) {
    showNotification(msg, senderId);
  }
});

// =====================
// HI·ªÇN TH·ªä TIN NH·∫ÆN
// =====================
function appendMessage(msg) {
  const chatBox = document.getElementById("chat-box");
  if (!chatBox) return;

  const isMe = String(msg.sender_id) === String(currentUserId);
  const div = document.createElement("div");
  div.className = "chat-message " + (isMe ? "me" : "them");

  const timeString = formatTime(msg.timestamp);

  div.innerHTML = `
    <div class="bubble">
      ${msg.content}
      <small>${timeString}</small>
    </div>
  `;

  chatBox.appendChild(div);
  scrollChatToBottom();
}

function scrollChatToBottom() {
  const chatBox = document.getElementById("chat-box");
  if (chatBox) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}

// =====================
// G·ª¨I TIN NH·∫ÆN
// =====================
function sendChatMessage(){
  const input = document.getElementById("chat-input");
  if(!input) return;
  const content = input.value.trim();
  if(!content || !currentChatPeer) return;
  
  const tempMsg = {
    _id: 'temp-' + Date.now(),
    sender_id: currentUserId,
    content: content,
    timestamp: new Date().toISOString(),
    seen: false
  };
  
  appendMessage(tempMsg);
  
  socket.emit("send_message", {peer_id: currentChatPeer, content});
  input.value = "";
  sendTyping(false);
}

// =====================
// X·ª¨ L√ù TYPING
// =====================
function sendTyping(isTyping){
  if(typingTimeout) clearTimeout(typingTimeout);
  if(currentChatPeer) socket.emit("typing", {peer_id: currentChatPeer, typing: isTyping});
  if(isTyping){
    typingTimeout = setTimeout(() => sendTyping(false), 3000);
  }
}

socket.on("typing", data => {
  const status = document.getElementById("typing-status");
  if(status) {
    status.innerText = data.typing ? 'ƒêang nh·∫≠p...' : '';
  }
});

// =====================
// C·∫¨P NH·∫¨T DANH S√ÅCH H·ªòI THO·∫†I KHI C√ì TIN NH·∫ÆN M·ªöI
// =====================
function updateConversationList(msg, isMe) {
  const senderId = String(msg.sender_id);
  let conversationIndex = conversations.findIndex(c => c.user_id === senderId);
  
  if (conversationIndex === -1) {
    const friend = friends.find(f => f._id === senderId);
    if (!friend) return;
    
    conversations.unshift({
      user_id: senderId,
      name: friend.name || friend.username || senderId,
      picture: friend.picture,
      last_message: msg.content,
      last_message_time: new Date().toISOString(),
      unread_count: 0
    });
    
    conversationIndex = 0;
  }
  
  conversations[conversationIndex].last_message = msg.content;
  conversations[conversationIndex].last_message_time = new Date().toISOString();
  
  if (!isMe && currentChatPeer !== senderId) {
    conversations[conversationIndex].unread_count = (conversations[conversationIndex].unread_count || 0) + 1;
    
    if (conversationIndex > 0) {
      const [movedItem] = conversations.splice(conversationIndex, 1);
      conversations.unshift(movedItem);
    }
  }
  
  if (!currentChatPeer) {
    renderConversationList();
  }
  updateMessageBadge();
}

// =====================
// HI·ªÇN TH·ªä TH√îNG B√ÅO TIN NH·∫ÆN M·ªöI
// =====================
function showNotification(msg, senderId) {
  const friend = friends.find(f => f._id === senderId);
  const senderName = friend ? (friend.name || friend.username) : "Ng∆∞·ªùi l·∫°";
  
  const toast = document.createElement("div");
  toast.className = "toast-notification";
  toast.innerHTML = `
    <div><b>${senderName}</b></div>
    <div>${msg.content}</div>
  `;
  
  toast.style.cursor = "pointer";
  toast.onclick = function() {
    openChatWindow({
      _id: senderId,
      name: senderName,
      picture: friend ? friend.picture : '/static/default-avatar.png'
    });
    this.remove();
  };
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 3000);
}
// =====================
// T·∫£i th√¥ng b√°o khi kh·ªüi ƒë·ªông
// =====================
function loadNotifications() {
  fetch('/api/notifications')
    .then(response => response.json())
    .then(notifications => {
      const notificationsList = document.getElementById("notifications-list");
      notifications.sort((a, b) => new Date(b.time) - new Date(a.time));
      if (notifications.length === 0) {
        notificationsList.innerHTML = '<div class="notification">Ch∆∞a c√≥ th√¥ng b√°o n√†o</div>';
      } else {
        notificationsList.innerHTML = '';
        notifications.forEach(notification => {
          addNotificationToUI(notification, !notification.seen);
        });
      }
      updateNotificationBadge();
    })
    .catch(error => {
      console.error('L·ªói t·∫£i th√¥ng b√°o:', error);
    });
}
// Kh·ªüi t·∫°o
socket.on("connect", () => {
  console.log("Socket connected!", socket.id);

  socket.emit("join_user_room", { user_id: currentUserId });
  loadFriends();

  // X√≥a listener c≈© v√† th√™m listener m·ªõi cho th√¥ng b√°o
  socket.off("new_notification");
  socket.on("new_notification", notification => {
    console.log("Nh·∫≠n th√¥ng b√°o m·ªõi:", notification);
    
    // CH·ªà x·ª≠ l√Ω th√¥ng b√°o n·∫øu n√≥ d√†nh cho user hi·ªán t·∫°i
    if (notification.to_user_id && notification.to_user_id !== currentUserId) {
      console.log("B·ªè qua th√¥ng b√°o kh√¥ng d√†nh cho user hi·ªán t·∫°i");
      return;
    }
    
    // C·∫≠p nh·∫≠t badge
    updateNotificationBadge();

    // N·∫øu ƒëang ·ªü tab th√¥ng b√°o, th√™m th√¥ng b√°o m·ªõi v√†o danh s√°ch
    const isNotificationTab = document.getElementById('notifications-container').style.display === 'block';
    
    if (isNotificationTab) {
      // N·∫øu ƒëang ·ªü tab th√¥ng b√°o, th√™m ngay v√†o UI
      addNotificationToUI(notification, true);
    } else {
      // N·∫øu kh√¥ng ·ªü tab th√¥ng b√°o, l∆∞u v√†o m·∫£ng pending
      pendingNotifications.push(notification);
      
      // Hi·ªÉn th·ªã toast notification
      showToastNotification(notification);
    }
  });
  
  setTimeout(() => {
    loadConversations();
  }, 500);
});

// =====================
// KI·ªÇM TRA T·∫§T C·∫¢ TR·∫†NG TH√ÅI KHI T·∫¢I TRANG
// =====================
document.addEventListener('DOMContentLoaded', function() {
  if (currentUserId) {
    loadNotifications();
    loadConversations();
  }
  
  // C·∫≠p nh·∫≠t badge th√¥ng b√°o khi t·∫£i trang
  updateNotificationBadge();
});
</script>

</body>
</html>